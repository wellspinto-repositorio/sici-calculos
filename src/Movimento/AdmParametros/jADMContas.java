package Movimento.AdmParametros;

import Funcoes.Db;
import Funcoes.FuncoesGlobais;
import Funcoes.TableControl;
import Funcoes.VariaveisGlobais;
import java.sql.ResultSet;
import javax.swing.JOptionPane;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;

public class jADMContas extends javax.swing.JPanel {
    Db conn = VariaveisGlobais.conexao;
    String tag = "UPDATE";
    
    /**
     * Creates new form jADMContas
     */
    public jADMContas() {
        initComponents();
        
        LerContas();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        a_sigla = new javax.swing.JTextField();
        jLabel1 = new javax.swing.JLabel();
        a_desc = new javax.swing.JTextField();
        jLabel2 = new javax.swing.JLabel();
        a_btsave = new javax.swing.JButton();
        a_btadc = new javax.swing.JButton();
        a_btdel = new javax.swing.JButton();
        jScrollPane1 = new javax.swing.JScrollPane();
        jContas = new javax.swing.JTable();

        setMaximumSize(new java.awt.Dimension(772, 314));
        setMinimumSize(new java.awt.Dimension(772, 314));

        a_sigla.setEditable(false);

        jLabel1.setText("Sigla");

        jLabel2.setText("Descrição");

        a_btsave.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Figuras/ok.png"))); // NOI18N
        a_btsave.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                a_btsaveActionPerformed(evt);
            }
        });

        a_btadc.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Figuras/edit.png"))); // NOI18N
        a_btadc.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                a_btadcActionPerformed(evt);
            }
        });

        a_btdel.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Figuras/stop.png"))); // NOI18N
        a_btdel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                a_btdelActionPerformed(evt);
            }
        });

        jContas.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {

            }
        ));
        jContas.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        jContas.getTableHeader().setReorderingAllowed(false);
        jScrollPane1.setViewportView(jContas);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel1)
                            .addComponent(a_sigla, javax.swing.GroupLayout.PREFERRED_SIZE, 53, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jLabel2)
                                .addGap(0, 0, Short.MAX_VALUE))
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(a_desc, javax.swing.GroupLayout.DEFAULT_SIZE, 597, Short.MAX_VALUE)
                                .addGap(1, 1, 1)
                                .addComponent(a_btsave, javax.swing.GroupLayout.PREFERRED_SIZE, 32, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(a_btadc, javax.swing.GroupLayout.PREFERRED_SIZE, 32, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(1, 1, 1)
                                .addComponent(a_btdel, javax.swing.GroupLayout.PREFERRED_SIZE, 32, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addContainerGap())))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addComponent(jScrollPane1)
                        .addContainerGap())))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(jLabel2))
                .addGap(2, 2, 2)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                    .addComponent(a_btdel, javax.swing.GroupLayout.PREFERRED_SIZE, 28, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(a_btadc, javax.swing.GroupLayout.PREFERRED_SIZE, 28, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(a_btsave, javax.swing.GroupLayout.PREFERRED_SIZE, 28, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(a_desc, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(a_sigla, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 250, Short.MAX_VALUE)
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void a_btsaveActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_a_btsaveActionPerformed
        if (tag.equalsIgnoreCase("UPDATE")) {
            String sql = "UPDATE adm SET descr = '&1.' WHERE codigo = '&2.'";
            sql = FuncoesGlobais.Subst(sql, new String[] {a_desc.getText().trim(), a_sigla.getText().trim()});
            try { conn.CommandExecute(sql); } catch (Exception ex) {ex.printStackTrace();}
            // Altera exibicão
            TableControl.alt(jContas, a_desc.getText().trim(), jContas.getSelectedRow(), 1);
            // Atualiza collections
            VariaveisGlobais.dCliente.set(a_sigla.getText().trim(),a_desc.getText().trim());
        } else {
            String sql = "INSERT INTO adm (codigo, descr) VALUES ('&1.','&2.')";
            sql = FuncoesGlobais.Subst(sql, new String[] {a_sigla.getText().trim(), a_desc.getText().trim()});
            try {
                conn.CommandExecute(sql);
                conn.SaveParameters(new String[] {"CONTAS",a_sigla.getText().trim(),"TEXTO"});

                // Inclui exibicão
                TableControl.add(jContas, new String[][] {{a_sigla.getText().trim(), a_desc.getText().trim()},{"C","L"}},true);
                // Atualiza collections
                VariaveisGlobais.dCliente.add(a_sigla.getText().trim(),a_desc.getText().trim());
            } catch (Exception ex) {ex.printStackTrace();}
        }
        tag = "UPDATE";
        jContas.repaint();
    }//GEN-LAST:event_a_btsaveActionPerformed

    private void a_btadcActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_a_btadcActionPerformed
        tag = "INSERT";
        a_btsave.setEnabled(true);

        a_sigla.setText(CTACOD());
        a_desc.setText("");
        a_desc.requestFocus();
    }//GEN-LAST:event_a_btadcActionPerformed

    private void a_btdelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_a_btdelActionPerformed
        Object[] options = { "Sim", "Não" };
        int n = JOptionPane.showOptionDialog(null,
            "Deseja excluir esta Conta ??? ",
            "Atenção", JOptionPane.YES_NO_OPTION,
            JOptionPane.QUESTION_MESSAGE, null, options, options[0]);
        if (n == JOptionPane.YES_OPTION) {
            String sql = "DELETE FROM adm WHERE codigo = '&1.' AND descr = '&2.'";
            String tcodigo = jContas.getValueAt(jContas.getSelectedRow(), 0).toString();
            String tdescr  = jContas.getValueAt(jContas.getSelectedRow(), 1).toString();
            sql = FuncoesGlobais.Subst(sql, new String[] {tcodigo, tdescr});
            try { conn.CommandExecute(sql); } catch (Exception e) {}

            a_btdel.setEnabled(false);

            // Deleta da tabela
            TableControl.del(jContas, jContas.getSelectedRow());
            // Atualiza collections
            VariaveisGlobais.dCliente.remove(tcodigo);

            // Refresca tela
            a_sigla.setText(""); a_desc.setText("");

            jContas.repaint();
        }
    }//GEN-LAST:event_a_btdelActionPerformed

    private void LerContas() {
        TableControl.header(jContas, new String[][] {{"codigo", "descrição"},{"60","600"}});
        
        a_btadc.setEnabled(true);
        a_btdel.setEnabled(false);
        a_btsave.setEnabled(false);
        
        jContas.getSelectionModel().addListSelectionListener(new ListSelectionListener() {
            @Override
            public void valueChanged(ListSelectionEvent e) {  
                a_sigla.setText(jContas.getValueAt(jContas.getSelectedRow(), 0).toString());
                a_desc.setText(jContas.getValueAt(jContas.getSelectedRow(), 1).toString());
                
                a_btdel.setEnabled(!(jContas.getSelectedRow() >= 0 && jContas.getSelectedRow() <= 7));
                tag = "UPDATE";
                a_btsave.setEnabled(true);
            }});

        FillContas();
    }
    
    private void FillContas() {
        String sSql = "SELECT codigo, descr FROM adm ORDER BY autoid;";
        ResultSet rs = conn.OpenTable(sSql, null);
        try {
            while (rs.next()) {
                String tcodigo = rs.getString("codigo");
                String tdescr = rs.getString("descr");
                
                TableControl.add(jContas, new String[][]{{tcodigo, tdescr}, {"C","L"}},true);
            }
        } catch (Exception ex) {ex.printStackTrace();}
        conn.CloseTable(rs);
    }
    
    private String CTACOD() {
        String sCod = "";
        char sPt1;
        char sPt2;
        try { sCod = conn.ReadParameters("CONTAS"); } catch (Exception ex) {}
        if (sCod.trim().equals("")) {
            sCod = "A1";
        } else {
            sPt1 = sCod.charAt(0);
            sPt2 = sCod.charAt(1);
            
            if (sPt2 + 1 > 57) {
                sPt2 = '1';
                sPt1 = (char)((int)sPt1 + 1);
                if (sPt1 == 'Z') sPt1 = 'A';
            } else {
                sPt2 = (char)((int)sPt2 + 1);
            }
            
            sCod = "" + sPt1 + sPt2;
        }
        
        return sCod;
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton a_btadc;
    private javax.swing.JButton a_btdel;
    private javax.swing.JButton a_btsave;
    private javax.swing.JTextField a_desc;
    private javax.swing.JTextField a_sigla;
    private javax.swing.JTable jContas;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JScrollPane jScrollPane1;
    // End of variables declaration//GEN-END:variables
}
